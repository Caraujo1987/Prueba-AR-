<!DOCTYPE html>
<html lang="en">
<head>
    <title>AR con Geolocalizaci√≥n</title>
    <meta charset="utf-8">
    <meta name="description" content="Modelo 3D con geolocalizaci√≥n">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <style>
        body { margin: 0; overflow: hidden; text-align: center; font-family: Arial, sans-serif; }
        #status { font-size: 18px; color: red; margin: 20px; }
        #coords { font-size: 16px; margin: 10px; }
        #ar-button, #captureButton {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        #captureButton { bottom: 60px; background-color: #007bff; color: white; }
        #ar-button { bottom: 20px; background-color: #ff4081; color: white; }
    </style>

    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jeromeetienne/AR.js/aframe/build/aframe-ar.min.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
</head>

<body>

    <h3 id="status">üìç Esperando ubicaci√≥n...</h3>
    <h4 id="coords">Latitud: ---, Longitud: ---</h4>

    <!-- ModelViewer -->
    <model-viewer id="modelViewer" src="gumball_carro_car.glb" ar ar-modes="webxr scene-viewer quick-look"
        camera-controls tone-mapping="neutral" poster="poster.webp" shadow-intensity="1">
        <div class="progress-bar hide" slot="progress-bar">
            <div class="update-bar"></div>
        </div>
        <button slot="ar-button" id="ar-button">Ver en tu espacio</button>
    </model-viewer>

    <button id="captureButton">Tomar foto</button>

    <!-- AR.js con geolocalizaci√≥n -->
    <a-scene embedded arjs>
        <a-camera gps-new-camera="gpsMinDistance: 1"></a-camera>

        <a-entity 
            gltf-model="gumball_carro_car.glb" 
            gps-new-entity-place="latitude: 3.34147; longitude: -76.53033" 
            scale="5 5 5" 
            id="ar-model">
        </a-entity>
    </a-scene>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const statusText = document.getElementById("status");
            const coordsText = document.getElementById("coords");

            if ("geolocation" in navigator) {
                statusText.innerText = "üì° Obteniendo ubicaci√≥n...";
                
                navigator.geolocation.watchPosition((position) => {
                    let lat = position.coords.latitude;
                    let lon = position.coords.longitude;
                    
                    coordsText.innerText = `üìç Latitud: ${lat.toFixed(6)}, Longitud: ${lon.toFixed(6)}`;
                    statusText.innerText = "‚úÖ Ubicaci√≥n detectada en tiempo real";
                    
                    console.log(`Ubicaci√≥n en tiempo real: Lat ${lat}, Lon ${lon}`);
                }, (error) => {
                    statusText.innerText = "‚ùå Error obteniendo ubicaci√≥n.";
                    coordsText.innerText = "‚ö†Ô∏è No se pudo obtener la ubicaci√≥n.";
                    console.error("Error de GPS:", error);
                }, {
                    enableHighAccuracy: true, // Mejor precisi√≥n
                    maximumAge: 0, // No usar cach√©
                    timeout: 5000 // Espera 5 segundos m√°ximo
                });

            } else {
                statusText.innerText = "‚ö†Ô∏è Geolocalizaci√≥n no soportada en este navegador.";
                coordsText.innerText = "‚ùå No se puede obtener ubicaci√≥n.";
            }
        });

        // Bot√≥n de captura de imagen
        document.getElementById('captureButton').addEventListener('click', () => {
            const modelViewer = document.getElementById('modelViewer');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = modelViewer.clientWidth;
            canvas.height = modelViewer.clientHeight;
            context.drawImage(modelViewer, 0, 0, canvas.width, canvas.height);
            const image = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.href = image;
            link.download = 'captura_modelo.png';
            link.click();
        });
    </script>

</body>
</html>
